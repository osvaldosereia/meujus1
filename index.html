<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeuJus - Estudo Contínuo</title>
    <meta name="description" content="MeuJus - Estudo contínuo de questões. Estude Direito Penal, Civil e mais com questões aleatórias e foco na revisão.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        /* Estilo minimalista (Apple) */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* --- ESTILOS DROPDOWN (SINGLE-SELECT) --- */
        .custom-select-container { position: relative; }
        .custom-select-button {
            width: 100%; padding: 0.75rem; border: 1px solid #D1D5DB; border-radius: 0.375rem;
            background-color: #F9FAFB; display: flex; justify-content: space-between;
            align-items: center; cursor: pointer; text-align: left;
            font-size: 0.875rem; /* 14px */
        }
        .custom-select-button:focus { outline: none; box-shadow: 0 0 0 2px #3B82F6; }
        .custom-select-list {
            position: absolute; top: 100%; left: 0; right: 0; background-color: white;
            border: 1px solid #D1D5DB; border-top: none; border-radius: 0 0 0.375rem 0.375rem;
            max-height: 250px; overflow-y: auto; z-index: 10;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .custom-select-search {
            width: 100%; padding: 0.5rem 0.75rem; border-bottom: 1px solid #E5E7EB; outline: none;
            position: sticky; 
            top: 0; 
            background-color: white; 
            z-index: 11; 
        }
        .custom-select-option {
            padding: 0.5rem 0.75rem; cursor: pointer; user-select: none;
            display: flex; align-items: center; gap: 0.5rem;
            font-size: 0.875rem; /* <-- ALTERADO: Fonte menor para subcategorias */
        }
        .custom-select-option:hover { background-color: #F3F4F6; }
        .custom-select-option.selected { background-color: #DBEAFE; font-weight: 500; }
        
        /* --- ESTILOS (MULTI-SELECT) --- */
        .custom-select-option.multi-selected { background-color: #E0E7FF; font-weight: 500; }
        /* pseudo-elemento para checkbox */
        .custom-select-option.multi-select::before {
            content: ''; width: 1rem; height: 1rem; border: 1px solid #9CA3AF;
            border-radius: 0.25rem; background-color: #F9FAFB; flex-shrink: 0;
        }
        .custom-select-option.multi-select.multi-selected::before {
            background-color: #4F46E5; border-color: #4F46E5;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20' fill='white'%3E%3Cpath fill-rule='evenodd' d='M16.704 5.296a.75.75 0 010 1.06l-7.5 7.5a.75.75 0 01-1.06 0l-3.5-3.5a.75.75 0 011.06-1.06L9 12.94l7.146-7.147a.75.75 0 011.06 0z' clip-rule='evenodd' /%3E%3C/svg%3E");
        }
        /* "Pins" de seleção */
        #multiSelectPins { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.75rem; }
        .pin-item {
            display: flex; align-items: center; gap: 0.375rem; font-size: 0.875rem; font-weight: 500;
            background-color: #E0E7FF; color: #3730A3; padding: 0.25rem 0.5rem; border-radius: 9999px;
        }
        .pin-remove { cursor: pointer; color: #4F46E5; font-weight: bold; }
        .pin-remove:hover { color: #3730A3; }

        /* --- ESTILOS DE VERIFICAÇÃO (MANTIDOS) --- */
        .alternativa-item.selected { background-color: #DBEAFE; border-color: #60A5FA; color: #1E40AF; }
        .alternativa-item.correct { background-color: #D1FAE5; border-color: #34D399; color: #065F46; font-weight: 500; }
        .alternativa-item.wrong { background-color: #FEE2E2; border-color: #F87171; color: #991B1B; font-weight: 500; }
        .alternativa-item.gabarito-correto { background-color: #D1FAE5; border-color: #34D399; }
        
        /* --- ESTILOS BOTÕES IA (MANTIDOS) --- */
        .sub-buttons-container { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .sub-buttons-container.expanded { max-height: 300px; transition: max-height 0.3s ease-in; }
        
        /* ### CSS: Estilo do Toast ### */
        .toast {
            position: fixed; top: 1.25rem; right: 1.25rem; z-index: 100;
            padding: 0.75rem 1.25rem; border-radius: 0.375rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            color: white; font-weight: 500;
            transform: translateX(120%); opacity: 0;
            transition: transform 0.3s ease-out, opacity 0.3s ease-out;
        }
        .toast.show { transform: translateX(0); opacity: 1; }
        .toast.bg-success { background-color: #16A34A; }
        .toast.bg-error { background-color: #DC2626; }
        .toast.bg-info { background-color: #2563EB; }

        /* ### CSS: Estilo dos Botões de Filtro ### */
        .filtro-btn {
            background-color: #F3F4F6; /* bg-gray-100 */
            color: #374151; /* text-gray-700 */
            transition: all 0.2s ease-in-out;
        }
        .filtro-btn.ativo {
            font-weight: 600; /* semibold */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }
        .filtro-btn.ativo.filtro-nao-respondi {
            background-color: #3B82F6; /* bg-blue-500 */
            color: white;
        }
        .filtro-btn.ativo.filtro-errado {
            background-color: #EF4444; /* bg-red-500 */
            color: white;
        }
        .filtro-btn.ativo.filtro-correto {
            background-color: #22C55E; /* bg-green-500 */
            color: white;
        }
        
        /* Estilo para o contador dentro do botão */
        .filtro-btn .contador {
            margin-left: 0.375rem; /* ml-1.5 */
            font-size: 0.75rem; /* text-xs */
            opacity: 0.8;
        }
        
    </style>
</head>
<body class="bg-gray-100">

    <nav class="bg-white shadow-sm sticky top-0 z-30">
        <div class="max-w-4xl mx-auto px-4 sm:px-6">
            <div class="flex justify-between items-center h-16">
                <div class="flex-shrink-0 flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">MeuJus</h1>
                </div>
                <div class="flex space-x-4">
                    <a href="/" class="text-blue-600 border-b-2 border-blue-600 px-3 py-2 rounded-md text-sm font-medium" aria-current="page">Estudo</a>
                    <a href="/vademecum/" class="text-gray-500 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Vademecum</a>
                </div>
            </div>
        </div>
    </nav>
    <div class="max-w-4xl mx-auto p-4 md:p-8">

        <section id="welcomeBox" class="mb-6 p-6 bg-white rounded-lg shadow-sm text-center">
            <h2 class="text-2xl font-semibold text-gray-800">Bem-vindo ao MeuJus!</h2>
            <p class="text-md text-gray-600 mt-1">
                Selecione a categoria, as subcategorias (até 5) e clique em "Buscar Questão".
            </p>
        </section>

        <section class="mb-6 p-6 bg-white rounded-lg shadow-sm">
            <div class="flex flex-col sm:flex-row gap-4 items-center sm:items-start"> 
                
                <div class="w-full sm:w-1/2">
                    <label for="selectDisciplinaBtn" class="block text-sm font-medium text-gray-700 mb-1">Categoria</label>
                    <div id="customSelectDisciplina" class="custom-select-container">
                        <button id="selectDisciplinaBtn" type="button" class="custom-select-button">
                            <span id="selectDisciplinaValue">Selecione...</span>
                            <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="selectDisciplinaList" class="custom-select-list hidden">
                            </div>
                    </div>
                </div>
                
                <div class="w-full sm:w-1/2">
                    <label for="selectTemaBtn" class="block text-sm font-medium text-gray-700 mb-1">Subcategoria (Máx. 5)</label>
                    <div id="customSelectTema" class="custom-select-container">
                        <button id="selectTemaBtn" type="button" class="custom-select-button">
                            <span id="selectTemaValue">Selecione...</span>
                             <svg class="w-5 h-5 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 01.707.293l3 3a1 1 0 01-1.414 1.414L10 5.414 7.707 7.707a1 1 0 01-1.414-1.414l3-3A1 1 0 0110 3zm-3.707 9.293a1 1 0 011.414 0L10 14.586l2.293-2.293a1 1 0 011.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                        <div id="selectTemaList" class="custom-select-list hidden">
                            <input type="text" id="selectTemaSearch" class="custom-select-search" placeholder="Buscar subcategoria...">
                            <div id="selectTemaOptions">
                                </div>
                        </div>
                    </div>
                    
                    <div id="multiSelectPins" class="mt-3">
                        </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 items-center mt-6">
                <div class="w-full">
                    <button id="btnBuscarQuestao" class="w-full px-6 py-3 font-semibold text-white rounded-md transition-all duration-300 bg-blue-600 hover:bg-blue-700 shadow-sm disabled:bg-gray-400 disabled:cursor-not-allowed" disabled>
                        Selecione uma subcategoria
                    </button>
                </div>
            </div>
        </section>

        <section id="divFiltros" class="hidden mb-6 p-4 bg-white rounded-lg shadow-sm flex flex-col sm:flex-row gap-3 justify-center">
            <button id="btnFiltroNaoRespondi" class="filtro-btn filtro-nao-respondi px-5 py-2 font-medium rounded-md w-full sm:w-auto">
                Não Respondi <span id="countNaoRespondi" class="contador"></span>
            </button>
            <button id="btnFiltroErrei" class="filtro-btn filtro-errado px-5 py-2 font-medium rounded-md w-full sm:w-auto">
                Errei <span id="countErrei" class="contador"></span>
            </button>
            <button id="btnFiltroAcertei" class="filtro-btn filtro-correto px-5 py-2 font-medium rounded-md w-full sm:w-auto">
                Acertei <span id="countAcertei" class="contador"></span>
            </button>
        </section>

        <section id="divBuscaPalavra" class="hidden mb-6 p-4 bg-white rounded-lg shadow-sm">
            <label for="inputBuscaPalavra" class="block text-sm font-medium text-gray-700 mb-2">
                Buscar por palavra-chave nas questões carregadas:
            </label>
            <div class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="inputBuscaPalavra" class="w-full sm:flex-1 px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Ex: Homicídio, Art. 121, etc. (Pressione Enter ou clique em Filtrar)">
                <button id="btnBuscaPalavra" class="w-full sm:w-auto px-6 py-2 font-semibold text-white bg-blue-600 rounded-md hover:bg-blue-700 transition-colors">
                    Filtrar
                </button>
                <button id="btnLimparBuscaPalavra" class="w-full sm:w-auto px-4 py-2 font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 hidden">
                    Limpar Filtro
                </button>
            </div>
        </section>

        <main id="areaProva">
            <div id="divStatus" class="text-center text-gray-600 p-10 text-lg">
                Selecione a categoria e as subcategorias para começar.
            </div>

            <div id="divQuestoes" class="space-y-6">
                </div>
        </main>

    </div>

    <div id="toastContainer">
        </div>


    <script src="config.js"></script>

    <script type="module">
        // O objeto 'dbDisciplinas' é carregado do arquivo 'config.js'
        
        // --- 1. Constantes ---
        const MAX_SUBCATEGORIAS = 5; // <-- ALTERADO: Limite para 5

        // --- 2. Referências aos Elementos do DOM ---
        const welcomeBox = document.getElementById('welcomeBox'); // NOVO: Referência ao box de boas-vindas
        
        const customSelectDisciplina = document.getElementById('customSelectDisciplina');
        const selectDisciplinaBtn = document.getElementById('selectDisciplinaBtn');
        const selectDisciplinaValue = document.getElementById('selectDisciplinaValue');
        const selectDisciplinaList = document.getElementById('selectDisciplinaList');
        const customSelectTema = document.getElementById('customSelectTema');
        const selectTemaBtn = document.getElementById('selectTemaBtn');
        const selectTemaValue = document.getElementById('selectTemaValue');
        const selectTemaList = document.getElementById('selectTemaList');
        const selectTemaSearch = document.getElementById('selectTemaSearch');
        const selectTemaOptions = document.getElementById('selectTemaOptions');
        const multiSelectPins = document.getElementById('multiSelectPins'); 
        const btnBuscarQuestao = document.getElementById('btnBuscarQuestao'); 
        const divStatus = document.getElementById('divStatus');
        const divQuestoes = document.getElementById('divQuestoes');
        // const btnTopo = document.getElementById('btnTopo'); // REMOVIDO
        const toastContainer = document.getElementById('toastContainer');
        
        // Referências aos Filtros
        const divFiltros = document.getElementById('divFiltros');
        const btnFiltroNaoRespondi = document.getElementById('btnFiltroNaoRespondi');
        const btnFiltroErrei = document.getElementById('btnFiltroErrei');
        const btnFiltroAcertei = document.getElementById('btnFiltroAcertei');
        
        // Referências aos contadores dos filtros
        const countNaoRespondi = document.getElementById('countNaoRespondi');
        const countErrei = document.getElementById('countErrei');
        const countAcertei = document.getElementById('countAcertei');

        // Referências da Nova Busca por Palavra
        const divBuscaPalavra = document.getElementById('divBuscaPalavra');
        const inputBuscaPalavra = document.getElementById('inputBuscaPalavra');
        const btnBuscaPalavra = document.getElementById('btnBuscaPalavra');
        const btnLimparBuscaPalavra = document.getElementById('btnLimparBuscaPalavra');


        // --- 3. Estado da Aplicação ---
        let estadoSelect = {
            disciplina: { chave: null, nome: null, listaCompleta: [] },
            tema: { chavesSelecionadas: [], nomesSelecionados: [], listaCompleta: [], listaFiltrada: [] }
        };
        
        let questoesOriginais = []; // NOVO: Backup das questões antes de filtrar por palavra
        let questoesCarregadas = []; // O "bolo" de questões (agora é o conjunto filtrado)
        let filtroPalavraAtivo = false; // NOVO: Controla se o filtro por palavra está ativo
        
        let historicoNavegacao = []; // Questões vistas, com status
        let indiceHistorico = -1; // Posição atual no historicoNavegacao
        let perguntaAtual = null; // Objeto da questão atual
        let isLoading = false; 
        
        let filtroAtivo = 'nao-respondi'; // 'nao-respondi', 'errado', 'correto'

        // --- 4. Funções Principais ---

        // Função auxiliar para normalizar texto (remove acentos, ç -> c)
        function normalizarTexto(texto) {
            if (!texto) return '';
            return texto
                .toLowerCase()
                .normalize("NFD") // Decompor acentos
                .replace(/[\u0300-\u036f]/g, "") // Remover acentos
                .replace(/ç/g, "c"); // Tratar cedilha
        }

        function init() {
            if (typeof dbDisciplinas === 'undefined') {
                console.error("ERRO CRÍTICO: O ficheiro config.js não foi carregado ou está vazio.");
                divStatus.innerHTML = `<p class="font-semibold text-red-600">Erro Crítico.</p>
                                        <p class="text-sm text-gray-500 mt-1">O ficheiro <b>config.js</b> não foi encontrado ou está vazio. Verifique o console (F12) para mais detalhes.</p>`;
                return; 
            }
            
            popularDisciplinas();
            setupCustomSelectListeners();

            btnBuscarQuestao.addEventListener('click', buscarQuestoes);
            
            btnFiltroNaoRespondi.addEventListener('click', () => setFiltro('nao-respondi'));
            btnFiltroErrei.addEventListener('click', () => setFiltro('errado'));
            btnFiltroAcertei.addEventListener('click', () => setFiltro('correto'));
            
            // Listeners da Nova Busca por Palavra
            btnBuscaPalavra.addEventListener('click', filtrarQuestoesPorPalavra);
            btnLimparBuscaPalavra.addEventListener('click', limparFiltroPalavra);
            inputBuscaPalavra.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') {
                    filtrarQuestoesPorPalavra();
                }
            });
            
            atualizarEstadoBotaoBuscar();
        }
        
        function setupCustomSelectListeners() {
            document.addEventListener('click', (e) => {
                if (!customSelectDisciplina.contains(e.target)) selectDisciplinaList.classList.add('hidden');
                if (!customSelectTema.contains(e.target)) selectTemaList.classList.add('hidden');
            });
            selectDisciplinaBtn.addEventListener('click', () => {
                selectDisciplinaList.classList.toggle('hidden');
                selectTemaList.classList.add('hidden');
            });
            selectTemaBtn.addEventListener('click', () => {
                selectTemaList.classList.toggle('hidden');
                selectDisciplinaList.classList.add('hidden');
            });
            selectTemaSearch.addEventListener('input', (e) => {
                // Busca Flexível (sem acento/ç)
                const termo = normalizarTexto(e.target.value); 
                estadoSelect.tema.listaFiltrada = estadoSelect.tema.listaCompleta.filter(tema => {
                    const nomeNormalizado = normalizarTexto(tema.nome); 
                    return nomeNormalizado.includes(termo); 
                });
                renderizarOpcoesTema();
            });
        }

        // --- Funções de Seleção (Categoria/Disciplina) ---

        function popularDisciplinas() {
            selectDisciplinaList.innerHTML = ''; 
            estadoSelect.disciplina.listaCompleta = [];
            for (const [chave, valor] of Object.entries(dbDisciplinas)) {
                estadoSelect.disciplina.listaCompleta.push({ chave, nome: valor.nome });
                const optionEl = document.createElement('div');
                optionEl.className = 'custom-select-option';
                optionEl.textContent = valor.nome;
                optionEl.dataset.value = chave;
                optionEl.addEventListener('click', () => {
                    selecionarDisciplina(chave, valor.nome);
                    selectDisciplinaList.classList.add('hidden');
                });
                selectDisciplinaList.appendChild(optionEl);
            }
            if (estadoSelect.disciplina.listaCompleta.length > 0) {
                const primeira = estadoSelect.disciplina.listaCompleta[0];
                selecionarDisciplina(primeira.chave, primeira.nome);
            }
        }

        function selecionarDisciplina(chave, nome) {
            estadoSelect.disciplina.chave = chave;
            estadoSelect.disciplina.nome = nome;
            selectDisciplinaValue.textContent = nome;
            Array.from(selectDisciplinaList.children).forEach(child => {
                child.classList.toggle('selected', child.dataset.value === chave);
            });
            estadoSelect.tema.chavesSelecionadas = [];
            estadoSelect.tema.nomesSelecionados = [];
            popularTemas();
            atualizarVisualSelecaoTema();
            resetarEstadoEstudo();
            atualizarEstadoBotaoBuscar();
        }

        // --- Funções de Seleção (Subcategoria/Tema) ---
        
        function formatarChaveParaNome(chave) {
            if (!chave) return '';
            let nome = chave.replace(/_/g, ' ');
            try {
                 nome = nome.charAt(0).toUpperCase() + nome.slice(1).toLowerCase();
                 nome = nome.replace(/ \(/g, ' (').replace(/\((\w)/, (match, p1) => `(${p1.toUpperCase()}`);
                 nome = nome.replace(/- (\w)/, (match, p1) => `- ${p1.toUpperCase()}`);
            } catch (e) {
                 return chave.replace(/_/g, ' ');
            }
            return nome;
        }

        function popularTemas() {
            const disciplinaKey = estadoSelect.disciplina.chave;
            const temasArray = dbDisciplinas[disciplinaKey]?.temas || []; 
            
            estadoSelect.tema.listaCompleta = [];
            
            for (const chave of temasArray) { 
                const nomeFormatado = formatarChaveParaNome(chave);
                estadoSelect.tema.listaCompleta.push({ chave: chave, nome: nomeFormatado });
            }
            
            estadoSelect.tema.listaFiltrada = [...estadoSelect.tema.listaCompleta];
            renderizarOpcoesTema();
            atualizarVisualSelecaoTema();
        }

        function renderizarOpcoesTema() {
            selectTemaOptions.innerHTML = '';
            if (estadoSelect.tema.listaFiltrada.length === 0) {
                selectTemaOptions.innerHTML = '<div class="custom-select-option text-gray-500">Nenhum tema encontrado.</div>';
                return;
            }
            estadoSelect.tema.listaFiltrada.forEach(tema => {
                const optionEl = document.createElement('div');
                optionEl.className = 'custom-select-option multi-select'; 
                optionEl.textContent = tema.nome;
                optionEl.dataset.value = tema.chave;
                optionEl.dataset.nome = tema.nome;
                if (estadoSelect.tema.chavesSelecionadas.includes(tema.chave)) {
                    optionEl.classList.add('multi-selected');
                }
                optionEl.addEventListener('click', () => {
                    toggleSelecaoTema(tema.chave, tema.nome);
                });
                selectTemaOptions.appendChild(optionEl);
            });
        }
        
        function toggleSelecaoTema(chave, nome) {
            const index = estadoSelect.tema.chavesSelecionadas.indexOf(chave);
            if (index > -1) {
                estadoSelect.tema.chavesSelecionadas.splice(index, 1);
                estadoSelect.tema.nomesSelecionados.splice(index, 1);
            } else {
                if (estadoSelect.tema.chavesSelecionadas.length >= MAX_SUBCATEGORIAS) {
                    // Mensagem usa a constante MAX_SUBCATEGORIAS (agora 5)
                    showToast(`Máximo de ${MAX_SUBCATEGORIAS} subcategorias atingido.`, 'info'); 
                    return;
                }
                estadoSelect.tema.chavesSelecionadas.push(chave);
                estadoSelect.tema.nomesSelecionados.push(nome);
            }
            resetarEstadoEstudo();
            atualizarVisualSelecaoTema();
            
            const optionEl = selectTemaOptions.querySelector(`[data-value="${chave}"]`);
            if (optionEl) optionEl.classList.toggle('multi-selected', index === -1);
            
            atualizarEstadoBotaoBuscar();
        }

        function atualizarVisualSelecaoTema() {
            const count = estadoSelect.tema.chavesSelecionadas.length;
            if (count === 0) { selectTemaValue.textContent = 'Selecione...'; }
            else if (count === 1) { selectTemaValue.textContent = estadoSelect.tema.nomesSelecionados[0]; }
            else { selectTemaValue.textContent = `${count} subcategorias selecionadas`; }
            
            multiSelectPins.innerHTML = '';
            estadoSelect.tema.nomesSelecionados.forEach((nome, index) => {
                const chave = estadoSelect.tema.chavesSelecionadas[index];
                const pin = document.createElement('div');
                pin.className = 'pin-item';
                pin.innerHTML = `<span>${nome}</span> <span class="pin-remove" data-chave="${chave}" title="Remover">&times;</span>`;
                pin.querySelector('.pin-remove').addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    toggleSelecaoTema(chave, nome);
                });
                multiSelectPins.appendChild(pin);
            });
        }
        
        function resetarEstadoEstudo() {
            welcomeBox.classList.remove('hidden'); // ALTERADO: Mostra o box de boas-vindas
            
            divQuestoes.innerHTML = ''; 
            divFiltros.classList.add('hidden'); 
            divBuscaPalavra.classList.add('hidden'); 
            
            questoesCarregadas = [];
            questoesOriginais = []; 
            filtroPalavraAtivo = false; 
            
            historicoNavegacao = [];
            indiceHistorico = -1;
            perguntaAtual = null;
            filtroAtivo = 'nao-respondi'; 
            divStatus.textContent = 'Seleção alterada. Clique em "Buscar Questão".';
            divStatus.classList.remove('hidden');
            
            atualizarContadoresFiltros(); 
        }
        
        // --- Funções de Carregamento e Navegação ---
        
        function atualizarEstadoBotaoBuscar() {
            const temSelecao = estadoSelect.tema.chavesSelecionadas.length > 0;
            
            if (isLoading) {
                btnBuscarQuestao.disabled = true;
                btnBuscarQuestao.textContent = 'Carregando...';
            } else if (temSelecao) {
                btnBuscarQuestao.disabled = false;
                btnBuscarQuestao.textContent = 'Buscar Questão';
            } else {
                btnBuscarQuestao.disabled = true;
                btnBuscarQuestao.textContent = 'Selecione uma subcategoria';
            }
        }
        
        async function buscarQuestoes() {
            if (isLoading) return; 

            const { chavesSelecionadas } = estadoSelect.tema;
            const disciplinaKey = estadoSelect.disciplina.chave;
            
            if (chavesSelecionadas.length === 0) return; 

            resetarEstadoEstudo();
            divStatus.textContent = 'Carregando questões...';
            divStatus.classList.remove('hidden');
            
            welcomeBox.classList.add('hidden'); // ALTERADO: Esconde o box de boas-vindas
            
            isLoading = true; 
            atualizarEstadoBotaoBuscar(); 

            const urls = chavesSelecionadas.map(chave => `data/${disciplinaKey}/${chave}.json`);
            
            try {
                const promises = urls.map(url => fetch(url).then(res => {
                    if (!res.ok) {
                        console.error(`Falha ao carregar ${url}. Status: ${res.status}`);
                        throw new Error(`Falha ao carregar ${url}`);
                    }
                    return res.json();
                }));
                const arraysDeQuestoes = await Promise.all(promises);
                
                // Bloco de gerenciamento das questões
                questoesOriginais = [].concat(...arraysDeQuestoes); 
                questoesOriginais.forEach(q => { 
                    q.status = 'nao-respondi'; 
                    q.respostaUsuario = null; 
                });
                
                questoesCarregadas = [...questoesOriginais]; 
                filtroPalavraAtivo = false;
                
                if (questoesCarregadas.length === 0) {
                    throw new Error("Nenhuma questão foi encontrada para as subcategorias selecionadas.");
                }
                
                divFiltros.classList.remove('hidden');
                
                // Mostra e reseta a barra de busca por palavra
                divBuscaPalavra.classList.remove('hidden'); 
                btnLimparBuscaPalavra.classList.add('hidden');
                btnBuscaPalavra.disabled = false;
                inputBuscaPalavra.disabled = false;
                inputBuscaPalavra.value = '';
                
                atualizarContadoresFiltros(); 
                setFiltro('nao-respondi', true); 

            } catch (error) {
                console.error("Erro ao carregar questões:", error);
                divStatus.innerHTML = `<p class="font-semibold text-red-600">Nenhum resultado.</p><p class="text-sm text-gray-500 mt-2">Nenhuma questão foi encontrada para esta combinação de filtros. Verifique os arquivos JSON.</p>`;
                divStatus.classList.remove('hidden');
                divQuestoes.innerHTML = '';
                divBuscaPalavra.classList.add('hidden'); 
            } finally {
                isLoading = false; 
                atualizarEstadoBotaoBuscar(); 
            }
        }
        
        // ==============================================================
        // == INÍCIO: FUNÇÕES DE BUSCA POR PALAVRA-CHAVE (sem alterações) ==
        // ==============================================================

        // Função auxiliar para verificar se a questão contém o termo
        function questaoContemTermo(questao, termo) {
            if (!termo) return true; 
            
            const termoNormalizado = normalizarTexto(termo);

            // 1. Enunciado Principal (ou único)
            let textoCompleto = normalizarTexto(questao.enunciado_principal) + ' ' + normalizarTexto(questao.enunciado);
            
            // 2. Enunciado Pergunta (se houver)
            if (questao.enunciado_pergunta) {
                textoCompleto += ' ' + normalizarTexto(questao.enunciado_pergunta);
            }
            
            // 3. Itens/Assertivas (se houver)
            if (questao.itens_assertiva && questao.itens_assertiva.length > 0) {
                for (const item of questao.itens_assertiva) {
                    textoCompleto += ' ' + normalizarTexto(item);
                }
            }
            
            // 4. Alternativas
            if (questao.alternativas && questao.alternativas.length > 0) {
                for (const alt of questao.alternativas) {
                    textoCompleto += ' ' + normalizarTexto(alt.texto);
                }
            }
            
            return textoCompleto.includes(termoNormalizado); 
        }

        // Função principal para aplicar o filtro de palavra
        function filtrarQuestoesPorPalavra() {
            const termo = inputBuscaPalavra.value;
            if (!termo || termo.trim() === '') {
                showToast("Digite um termo para filtrar.", 'info');
                return;
            }
            
            const questoesFiltradas = questoesOriginais.filter(q => questaoContemTermo(q, termo));
            
            if (questoesFiltradas.length === 0) {
                showToast(`Nenhuma questão encontrada com "${termo}".`, 'info');
                divStatus.textContent = `Nenhuma questão encontrada para "${termo}".`;
                divStatus.classList.remove('hidden');
                divQuestoes.innerHTML = '';
                questoesCarregadas = []; 
                atualizarContadoresFiltros(); 
                
                filtroPalavraAtivo = false;
                btnLimparBuscaPalavra.classList.add('hidden');
                btnBuscaPalavra.disabled = false;
                inputBuscaPalavra.disabled = false;
                return;
            }

            questoesCarregadas = questoesFiltradas;
            filtroPalavraAtivo = true;
            btnLimparBuscaPalavra.classList.remove('hidden');
            btnBuscaPalavra.disabled = true; 
            inputBuscaPalavra.disabled = true;

            showToast(`${questoesCarregadas.length} questões filtradas por "${termo}".`, 'success');
            
            historicoNavegacao = [];
            indiceHistorico = -1;
            atualizarContadoresFiltros();
            setFiltro('nao-respondi', true); 
        }

        // Função para limpar o filtro de palavra
        function limparFiltroPalavra() {
            questoesCarregadas = [...questoesOriginais]; 
            filtroPalavraAtivo = false;
            
            inputBuscaPalavra.value = '';
            inputBuscaPalavra.disabled = false;
            btnBuscaPalavra.disabled = false;
            btnLimparBuscaPalavra.classList.add('hidden');
            
            showToast("Filtro de palavra-chave removido.", 'info');
            
            historicoNavegacao = [];
            indiceHistorico = -1;
            atualizarContadoresFiltros();
            setFiltro('nao-respondi', true); 
        }
        
        // ==============================================================
        // == FIM: FUNÇÕES DE BUSCA POR PALAVRA-CHAVE
        // ==============================================================


        // --- Sistema de Filtros ---

        function atualizarContadoresFiltros() {
            if (questoesCarregadas.length === 0) {
                countNaoRespondi.textContent = '';
                countErrei.textContent = '';
                countAcertei.textContent = '';
                return;
            }

            const totalNaoRespondi = questoesCarregadas.filter(q => q.status === 'nao-respondi').length;
            const totalErrei = questoesCarregadas.filter(q => q.status === 'errado').length;
            const totalAcertei = questoesCarregadas.filter(q => q.status === 'correto').length;

            countNaoRespondi.textContent = `(${totalNaoRespondi})`;
            countErrei.textContent = `(${totalErrei})`;
            countAcertei.textContent = `(${totalAcertei})`;
        }

        function setFiltro(novoFiltro, forcarBusca = true) {
            filtroAtivo = novoFiltro;
            indiceHistorico = -1; 
            
            btnFiltroNaoRespondi.classList.toggle('ativo', novoFiltro === 'nao-respondi');
            btnFiltroErrei.classList.toggle('ativo', novoFiltro === 'errado');
            btnFiltroAcertei.classList.toggle('ativo', novoFiltro === 'correto');
            
            if (forcarBusca) {
                buscarProximaQuestao();
            }
        }
        
        function buscarProximaQuestao() {
            let questaoEncontrada = null;
            
            if (filtroAtivo === 'nao-respondi') {
                const poolNaoRespondidas = questoesCarregadas.filter(q => q.status === 'nao-respondi');
                
                if (poolNaoRespondidas.length === 0) {
                    const msgFiltro = filtroPalavraAtivo ? "neste filtro de palavra-chave" : "deste conjunto";
                    showToast(`Você respondeu todas as questões ${msgFiltro}!`, 'success');
                    divQuestoes.innerHTML = '';
                    divStatus.textContent = `Parabéns! Você respondeu todas as questões ${msgFiltro}.`;
                    divStatus.classList.remove('hidden');
                    return;
                }
                questaoEncontrada = poolNaoRespondidas[Math.floor(Math.random() * poolNaoRespondidas.length)];
                
                indiceHistorico = historicoNavegacao.indexOf(questaoEncontrada);
                if (indiceHistorico === -1) {
                    historicoNavegacao.push(questaoEncontrada);
                    indiceHistorico = historicoNavegacao.length - 1;
                }
                
            } else {
                for (let i = indiceHistorico + 1; i < historicoNavegacao.length; i++) {
                    if (historicoNavegacao[i].status === filtroAtivo) {
                        questaoEncontrada = historicoNavegacao[i];
                        indiceHistorico = i;
                        break;
                    }
                }
                
                if (!questaoEncontrada) {
                    const msg = filtroAtivo === 'errado' ? 'Fim da revisão de erros.' : 'Fim da revisão de acertos.';
                    showToast(msg, 'info');
                    return;
                }
            }
            
            perguntaAtual = questaoEncontrada;
            exibirQuestao(perguntaAtual, indiceHistorico);
        }

        function buscarQuestaoAnterior() {
            let questaoEncontrada = null;

            if (filtroAtivo === 'nao-respondi') {
                if (indiceHistorico > 0) {
                    indiceHistorico--;
                    questaoEncontrada = historicoNavegacao[indiceHistorico];
                }
            } else {
                for (let i = indiceHistorico - 1; i >= 0; i--) {
                    if (historicoNavegacao[i].status === filtroAtivo) {
                        questaoEncontrada = historicoNavegacao[i];
                        indiceHistorico = i;
                        break;
                    }
                }
            }

            if (questaoEncontrada) {
                perguntaAtual = questaoEncontrada;
                exibirQuestao(perguntaAtual, indiceHistorico);
            } else {
                showToast("Você está no início da lista.", 'info');
            }
        }

        function navegarHistorico(direcao) {
            if (direcao === 'anterior') {
                buscarQuestaoAnterior();
            } else if (direcao === 'proximo') {
                buscarProximaQuestao();
            }
        }

        // --- Funções de Exibição da Questão ---

        function exibirQuestao(questao, indice) {
            divStatus.classList.add('hidden');
            divQuestoes.innerHTML = '';
            
            const elementoQuestao = criarElementoQuestao(questao, indice);
            divQuestoes.appendChild(elementoQuestao);
            
            if (questao.status !== 'nao-respondi') {
                pintarCorrecao(elementoQuestao, questao.gabarito, questao.respostaUsuario);
                elementoQuestao.dataset.respondida = 'true';
            }
            
            elementoQuestao.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function criarElementoQuestao(questao, indice) {
            const numero = indice + 1; 
            const card = document.createElement('div');
            card.className = 'bg-white p-6 rounded-lg shadow-md transition-all';
            card.dataset.id = questao.id || `q${numero}`;
            card.dataset.gabarito = questao.gabarito; 
            
            // 1. Metadados
            const metadataContainer = document.createElement('div');
            metadataContainer.className = 'flex justify-between items-center mb-3';
            const metadata = document.createElement('p');
            metadata.className = 'text-xs text-gray-500';
            metadata.textContent = `Questão ${numero} | ${questao.metadata || 'Sem metadados'}`;
            metadataContainer.appendChild(metadata);
            card.appendChild(metadataContainer);

            // 2. Enunciado (Simples vs. Complexo)
            if (questao.enunciado_principal && questao.itens_assertiva) {
                const enunciadoPrincipal = document.createElement('p');
                enunciadoPrincipal.className = 'text-base md:text-lg text-gray-800 mb-4 leading-relaxed';
                enunciadoPrincipal.innerHTML = formatarTexto(questao.enunciado_principal);
                card.appendChild(enunciadoPrincipal);
                const listaItens = document.createElement('ol');
                listaItens.className = 'list-none list-inside space-y-3 mb-4 pl-5 text-base md:text-lg text-gray-800 leading-relaxed';
                (questao.itens_assertiva || []).forEach(itemTexto => {
                    const li = document.createElement('li');
                    li.innerHTML = formatarTexto(itemTexto);
                    listaItens.appendChild(li);
                });
                card.appendChild(listaItens);
                if (questao.enunciado_pergunta) {
                    const perguntaFinal = document.createElement('p');
                    perguntaFinal.className = 'text-base md:text-lg text-gray-800 mb-5 leading-relaxed font-semibold';
                    perguntaFinal.innerHTML = formatarTexto(questao.enunciado_pergunta);
                    card.appendChild(perguntaFinal);
                }
            } else {
                const enunciado = document.createElement('p');
                enunciado.className = 'text-base md:text-lg text-gray-800 mb-5 leading-relaxed';
                const textoEnunciado = questao.enunciado || questao.enunciado_principal || "Enunciado não encontrado.";
                enunciado.innerHTML = formatarTexto(textoEnunciado);
                card.appendChild(enunciado);
            }

            // 3. Alternativas
            const alternativasContainer = document.createElement('div');
            alternativasContainer.className = 'space-y-3';
            (questao.alternativas || []).forEach(alt => {
                const altItem = document.createElement('div');
                altItem.className = 'alternativa-item flex items-center p-3 border border-gray-300 rounded-lg cursor-pointer transition-all duration-200 hover:bg-gray-50';
                altItem.style.marginLeft = '1rem'; 
                altItem.dataset.letra = alt.letra;
                const displayLetra = (alt.letra && alt.letra !== "") ? `${alt.letra})` : '';
                const textoAlternativa = formatarTexto(alt.texto);
                if (displayLetra) {
                    altItem.innerHTML = `<span class="font-semibold text-blue-600 w-6">${displayLetra}</span> <span class="ml-2 text-gray-700">${textoAlternativa}</span>`;
                } else {
                    altItem.dataset.letra = alt.texto.charAt(0).toUpperCase(); 
                    altItem.innerHTML = `<span class="ml-2 font-medium text-gray-800">${textoAlternativa}</span>`;
                }
                altItem.addEventListener('click', () => { verificarResposta(card, altItem); });
                alternativasContainer.appendChild(altItem);
            });
            card.appendChild(alternativasContainer);

            // 4. Gabarito (Oculto)
            const gabaritoDisplay = document.createElement('div');
            gabaritoDisplay.className = 'gabarito-oculto hidden mt-4 p-3 bg-blue-50 border border-blue-200 text-blue-800 rounded-md font-medium';
            gabaritoDisplay.textContent = `Gabarito: ${questao.gabarito}`;
            card.appendChild(gabaritoDisplay);

            // 5. Botões de IA e Navegação
            const aiAndNavContainer = criarBotoesIAeNav(questao, indice);
            card.appendChild(aiAndNavContainer);
            return card;
        }
        
        function verificarResposta(card, alternativaSelecionada) {
            if (card.dataset.respondida) return; 
            card.dataset.respondida = 'true';
            
            const gabarito = card.dataset.gabarito;
            const letraSelecionada = alternativaSelecionada.dataset.letra;
            const acertou = (gabarito === letraSelecionada);
            
            if (perguntaAtual) {
                perguntaAtual.status = acertou ? 'correto' : 'errado';
                perguntaAtual.respostaUsuario = letraSelecionada;
                atualizarContadoresFiltros(); 
            }
            
            pintarCorrecao(card, gabarito, letraSelecionada);
        }

        function pintarCorrecao(card, gabarito, respostaUsuario) {
            const gabaritoDisplay = card.querySelector('.gabarito-oculto');
            gabaritoDisplay.classList.remove('hidden');
            const acertou = (gabarito === respostaUsuario);
            if (acertou) {
                const altCorreta = card.querySelector(`.alternativa-item[data-letra="${gabarito}"]`);
                if (altCorreta) altCorreta.classList.add('correct');
                gabaritoDisplay.classList.replace('bg-blue-50', 'bg-green-50');
                gabaritoDisplay.classList.replace('border-blue-200', 'border-green-200');
                gabaritoDisplay.classList.replace('text-blue-800', 'text-green-800');
            } else {
                gabaritoDisplay.classList.replace('bg-blue-50', 'bg-red-50');
                gabaritoDisplay.classList.replace('border-blue-200', 'border-red-200');
                gabaritoDisplay.classList.replace('text-blue-800', 'text-red-800');
                const altCorreta = card.querySelector(`.alternativa-item[data-letra="${gabarito}"]`);
                if (altCorreta) altCorreta.classList.add('gabarito-correto');
                if (respostaUsuario) {
                    const altErrada = card.querySelector(`.alternativa-item[data-letra="${respostaUsuario}"]`);
                    if (altErrada) altErrada.classList.add('wrong');
                }
            }
        }

        // --- Funções de Criação de UI (Botões IA e Nav) ---

        function criarBotoesIAeNav(questao, indice) {
            const mainContainer = document.createElement('div');
            mainContainer.className = 'ai-nav-container mt-5 pt-4 border-t border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4';

            // LADO ESQUERDO: Botões IA
            const aiContainer = document.createElement('div');
            aiContainer.className = 'ai-buttons-container w-full sm:w-auto';
            const mainAiButton = document.createElement('button');
            mainAiButton.className = 'w-full sm:w-auto px-6 py-2 bg-blue-500 text-white rounded-md font-semibold hover:bg-blue-600 transition-colors duration-200 flex items-center justify-center gap-2';
            mainAiButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M9.293 2.293a1 1 0 0 1 1.414 0l4 4a1 1 0 0 1-1.414 1.414L11 5.414V14a1 1 0 1 1-2 0V5.414L6.707 7.707a1 1 0 0 1-1.414-1.414l4-4Z" clip-rule="evenodd" /><path fill-rule="evenodd" d="M.5 13.5A.5.5 0 0 1 1 13h18a.5.5 0 0 1 0 1H1a.5.5 0 0 1-.5-.5ZM13 16.5a.5.5 0 0 1 .5-.5h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1-.5-.5Z" clip-rule="evenodd" /></svg> Google modo IA`;
            aiContainer.appendChild(mainAiButton);
            const subButtonsContainer = document.createElement('div');
            subButtonsContainer.className = 'sub-buttons-container flex flex-col sm:flex-row flex-wrap gap-2 mt-2 w-full sm:w-auto';
            aiContainer.appendChild(subButtonsContainer);
            mainAiButton.addEventListener('click', () => {
                subButtonsContainer.classList.toggle('expanded');
                mainAiButton.querySelector('svg').classList.toggle('rotate-180');
            });
            const promptsAI = [
                { texto: "Comentário", prompt: "Comente o gabarito e fundamente sua explicação com embasamento jurídico detalhado, citando artigos de leis se possível. Explique por que a alternativa correta está certa e as outras estão erradas. Utilize uma linguagem formal e didática." },
                { texto: "Glossário", prompt: "Extraia os principais termos jurídicos ou conceitos complexos presentes no enunciado e nas alternativas. Para cada termo, forneça uma definição clara e concisa em formato de glossário." },
                { texto: "Dicas", prompt: "Com base no tema desta questão, indique possíveis pegadinhas de provas de concurso sobre o tema." },
                { texto: "Perguntas", prompt: "Com base no tema desta questão, crie perguntas que o estudante de direito precisa saber respondar. Responda todas elas de forma objetiva." },
                { texto: "Videoaula", prompt: "Encontre 3 videosaulas do YouTube que abordem o tema desta questão. Forneça os títulos dos vídeos e os links diretos para cada um. Priorize vídeos de canais renomados e com boa didática." },
                { texto: "Artigos", prompt: "Com base no tema desta questão, me de os artigos do codigo relacionado, súmulas e teses." }
            ];
            promptsAI.forEach(promptInfo => {
                const btn = document.createElement('button');
                btn.className = 'px-4 py-2 text-sm bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400 w-full sm:w-auto';
                btn.textContent = promptInfo.texto;
                btn.onclick = () => abrirGoogleIA(questao, promptInfo.prompt);
                subButtonsContainer.appendChild(btn);
            });
            mainContainer.appendChild(aiContainer);
            
            // LADO DIREITO: Botões de Navegação
            const navContainer = document.createElement('div');
            navContainer.className = 'flex items-center gap-2 w-full sm:w-auto';
            const btnAnterior = document.createElement('button');
            btnAnterior.className = 'flex-1 sm:flex-auto px-4 py-2 text-sm font-medium bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition-colors disabled:opacity-50 disabled:cursor-not-allowed';
            btnAnterior.innerHTML = `<span class="hidden sm:inline">Anterior</span><span class="sm:hidden">&lt;</span>`;
            btnAnterior.addEventListener('click', () => navegarHistorico('anterior'));
            
            const btnProximo = document.createElement('button');
            btnProximo.className = 'flex-1 sm:flex-auto px-4 py-2 text-sm font-medium bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors';
            btnProximo.innerHTML = `<span class="hidden sm:inline">Próximo</span><span class="sm:hidden">&gt;</span>`;
            btnProximo.addEventListener('click', () => navegarHistorico('proximo'));

            navContainer.appendChild(btnAnterior);
            navContainer.appendChild(btnProximo);
            mainContainer.appendChild(navContainer);
            return mainContainer;
        }

        function abrirGoogleIA(questao, promptPredefinido) {
            let contexto = "Considere a seguinte questão de concurso:\n\n";
            if (questao.enunciado_principal && questao.itens_assertiva) {
                contexto += `Enunciado Principal: ${questao.enunciado_principal}\n\nItens:\n`;
                (questao.itens_assertiva || []).forEach((item, index) => { contexto += `${item}\n`; });
                if (questao.enunciado_pergunta) { contexto += `\nPergunta: ${questao.enunciado_pergunta}\n`; }
            } else {
                contexto += `Enunciado: ${questao.enunciado || questao.enunciado_principal}\n`;
            }
            contexto += "\nAlternativas:\n";
            (questao.alternativas || []).forEach(alt => { contexto += `${alt.letra}) ${alt.texto}\n`; });
            contexto += `\nGabarito: ${questao.gabarito}\n\n`;
            const promptCompleto = `${promptPredefinido}\n\n${contexto}`;
            const urlQuery = encodeURIComponent(promptCompleto);
            const googleUrl = `https://www.google.com/search?udm=50&q=${urlQuery}`;
            window.open(googleUrl, '_blank');
        }
        
       function formatarTexto(texto) {
            if (!texto) return '';
            let html = texto;
            
            // 1. Mantém formatação de negrito e itálico (como já fazia)
            html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
            
            // 2. *** NOVA LÓGICA ***
            // Adiciona quebra de linha <br> antes de marcadores de lista.
            // A Regex (/( [IVXLCDM]+\. )/gi) procura por:
            // (espaço) (Numerais Romanos) (ponto) (espaço)
            // E substitui por: <br> (espaço) (Numerais Romanos) (ponto) (espaço)
            // A flag 'g' garante que TODOS os itens sejam formatados.
            // A flag 'i' torna a busca case-insensitive (pega I. ou i.)
            html = html.replace(/( [IVXLCDM]+\. )/gi, '<br>$1');

            // 3. *** NOVA LÓGICA ***
            // Adiciona quebra de linha dupla antes da pergunta final.
            // Isso é específico para o padrão que você mostrou.
            // (espaço)(Diante da legislação...)
            // vira: <br><br> (espaço)(Diante da legislação...)
            html = html.replace(/( Diante da legislação)/g, '<br><br>$1');

            return html;
        }
        
        // --- Sistema de Notificação "Toast" ---
        
        function showToast(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `toast bg-${type}`; 
            toast.textContent = message;
            
            toastContainer.appendChild(toast);
            
            getComputedStyle(toast).transform;
            
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            setTimeout(() => {
                toast.classList.remove('show'); 
                
                toast.addEventListener('transitionend', () => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                });
            }, duration);
        }

        // --- 5. Inicialização ---
        
        document.addEventListener('DOMContentLoaded', init);

    </script>
</body>
</html>
